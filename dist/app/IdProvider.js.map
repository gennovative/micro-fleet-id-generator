{"version":3,"sources":["app/IdProvider.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,oEAAiG;AACjG,0DAAqE;AACrE,8EAAmG;AAEnG,+CAA4C;AAE5C,MAAM,EAAE,cAAc,EAAE,IAAI,EAAE,WAAW,EAAE,CAAC,EAAE,WAAW,EAAE,CAAC,EAAE,GAAG,4BAAS,CAAC;AAI3E,IAAa,UAAU,kBAAvB;IAUC,YACuC,eAAuC,EACrC,UAA4B;QAD9B,oBAAe,GAAf,eAAe,CAAwB;QACrC,eAAU,GAAV,UAAU,CAAkB;QAEpE,mBAAK,CAAC,gBAAgB,CAAC,iBAAiB,EAAE,eAAe,CAAC,CAAC;QAC3D,mBAAK,CAAC,gBAAgB,CAAC,YAAY,EAAE,UAAU,CAAC,CAAC;QACjD,IAAI,CAAC,MAAM,GAAG,IAAI,yBAAW,EAAE,CAAC;IACjC,CAAC;IAED;;OAEG;IACI,IAAI;QACV,IAAI,CAAC,UAAU,CAAC,IAAI,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QACnE,IAAI,CAAC,UAAU,GAAQ,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC;QAC3E,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;IAED;;OAEG;IACI,UAAU;QAChB,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;IAED;;OAEG;IACI,OAAO;QACb,OAAO,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC;IAClC,CAAC;IAEM,KAAK;QACX,KAAK,IAAI,IAAI,IAAI,IAAI,CAAC,UAAU,EAAE;YACjC,IAAI,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE;gBAC3B,OAAO;aACP;SACD;IACF,CAAC;IAEM,UAAU;QAChB,OAAO,IAAI,CAAC,MAAM,CAAC,UAAU,EAAE,CAAC,QAAQ,EAAE,CAAC;IAC5C,CAAC;IAEM,WAAW;QACjB,OAAO,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC;IAClC,CAAC;IAEM,UAAU;QAChB,OAAO,IAAI,CAAC,MAAM,CAAC,UAAU,EAAE,CAAC;IACjC,CAAC;IAGa,WAAW,CAAC,OAAe;;YACxC,IAAI,CAAC,UAAU,CAAC,WAAW,GAAG,OAAO,CAAC;YACtC,OAAO,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC,CAAC,YAAY,EAAE;gBACpD,OAAO,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI;gBAC7B,KAAK,EAAE,YAAU,CAAC,UAAU;aAC5B,CAAC;iBACD,IAAI,CAAC,CAAC,GAAiB,EAAE,EAAE;gBAC3B,0BAA0B;gBAC1B,OAAO,IAAI,CAAC;YACb,CAAC,CAAC,CAAC;QACL,CAAC;KAAA;CACD,CAAA;AAxEe,qBAAU,GAAG,EAAE,CAAC;AAFnB,UAAU;IADtB,wBAAU,EAAE;IAYV,WAAA,oBAAM,CAAC,wBAAI,CAAC,eAAe,CAAC,CAAA;IAC5B,WAAA,oBAAM,CAAC,6BAAI,CAAC,iBAAiB,CAAC,CAAA;;GAZpB,UAAU,CA0EtB;AA1EY,gCAAU","file":"IdProvider.js","sourcesContent":["import { IConfigurationProvider, Types as ConT, constants } from '@micro-fleet/common-contracts';\r\nimport { injectable, inject, Guard } from '@micro-fleet/common-util';\r\nimport { IDirectRpcCaller, IRpcResponse, Types as ComT } from '@micro-fleet/service-communication';\r\n\r\nimport { IdGenerator } from './IdGenerator';\r\n\r\nconst { SvcSettingKeys: SvcS, ModuleNames: M, ActionNames: A } = constants;\r\n\r\n\r\n@injectable()\r\nexport class IdProvider implements IServiceAddOn {\r\n\r\n\tprivate static CACHE_SIZE = 10;\r\n\r\n\tprivate _addresses: string[];\r\n\tprivate _bigIntProm: Promise<string[]>;\r\n\r\n\t// TODO: Will implement remote ID generation later\r\n\tprivate _idGen: IdGenerator;\r\n\r\n\tconstructor(\r\n\t\t@inject(ConT.CONFIG_PROVIDER) private _configProvider: IConfigurationProvider,\r\n\t\t@inject(ComT.DIRECT_RPC_CALLER) private _rpcCaller: IDirectRpcCaller\r\n\t) {\r\n\t\tGuard.assertArgDefined('_configProvider', _configProvider);\r\n\t\tGuard.assertArgDefined('_rpcCaller', _rpcCaller);\r\n\t\tthis._idGen = new IdGenerator();\r\n\t}\r\n\r\n\t/**\r\n\t * @see IServiceAddOn.init\r\n\t */\r\n\tpublic init(): Promise<void> {\r\n\t\tthis._rpcCaller.name = this._configProvider.get(SvcS.SERVICE_SLUG);\r\n\t\tthis._addresses = <any>this._configProvider.get(SvcS.ID_SERVICE_ADDRESSES);\r\n\t\treturn Promise.resolve();\r\n\t}\r\n\r\n\t/**\r\n\t * @see IServiceAddOn.deadLetter\r\n\t */\r\n\tpublic deadLetter(): Promise<void> {\r\n\t\treturn Promise.resolve();\r\n\t}\r\n\r\n\t/**\r\n\t * @see IServiceAddOn.dispose\r\n\t */\r\n\tpublic dispose(): Promise<void> {\r\n\t\treturn this._rpcCaller.dispose();\r\n\t}\r\n\r\n\tpublic fetch(): Promise<void> {\r\n\t\tfor (let addr of this._addresses) {\r\n\t\t\tif (this.attempFetch(addr)) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic nextBigInt(): string {\r\n\t\treturn this._idGen.nextBigInt().toString();\r\n\t}\r\n\r\n\tpublic nextShortId(): string {\r\n\t\treturn this._idGen.nextShortId();\r\n\t}\r\n\r\n\tpublic nextUuidv4(): string {\r\n\t\treturn this._idGen.nextUuidv4();\r\n\t}\r\n\r\n\r\n\tprivate async attempFetch(address: string): Promise<boolean> {\r\n\t\tthis._rpcCaller.baseAddress = address;\r\n\t\treturn this._rpcCaller.call(M.ID_GEN, A.NEXT_BIG_INT, {\r\n\t\t\t\tservice: this._rpcCaller.name,\r\n\t\t\t\tcount: IdProvider.CACHE_SIZE\r\n\t\t\t})\r\n\t\t\t.then((res: IRpcResponse) => {\r\n\t\t\t\t// resolve(<any>res.data);\r\n\t\t\t\treturn true;\r\n\t\t\t});\r\n\t}\r\n}"]}